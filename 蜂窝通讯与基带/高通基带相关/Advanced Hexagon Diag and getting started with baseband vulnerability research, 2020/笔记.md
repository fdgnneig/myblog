- ä¸€å¥è¯æ€»ç»“ï¼Œå¼€å‘äº†diagtalkæ¡†æ¶ï¼Œä¸æ‰‹æœºä¸­/dev/diagè¿›è¡Œäº¤äº’ï¼Œä»è€Œæ¥å—åŸºå¸¦è¿è¡Œè¿‡ç¨‹ä¸­è¾“å‡ºçš„logå­—ç¬¦ä¸²ä¿¡æ¯ï¼Œå³æ˜¯å®ç°äº†åŸºå¸¦çš„logè¾“å‡º

- éœ€è¦ç ”ç©¶diagé©±åŠ¨ç¨‹åºï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼






â€¢ Advanced Hexagon Diag and getting started with baseband vulnerability research, 2020, Alisa Esage ***è¯¥ç ”ç©¶å¾ˆæœ‰ç”¨***
  - https://www.youtube.com/watch?v=94NwlrtGF7I

- ç ”ç©¶ç›®æ ‡æ˜¯nexus 6p


- ![](pic/2024-01-15-22-51-10.png)
- è¯¥æ¼”è®²è‡´åŠ›äº åŸºå¸¦ä¸­çš„ä¸€èˆ¬æ¼æ´ç ”ç©¶ï¼Œä½†æœ¬æ¬¡æ¼”è®²çš„ä¸»è¦ç„¦ç‚¹æ˜¯å…­è¾¹å½¢è¯Šæ–­ï¼Œä¹Ÿç§°ä¸º qcdm é«˜é€šè¯Šæ–­ç®¡ç†å™¨ï¼Œè¿™æ˜¯é«˜é€šå¼€å‘çš„ä¸“æœ‰åè®®ï¼Œç”¨äºå…¶åŸºå¸¦ï¼Œå¹¶ä¸”åŒ…å«åœ¨æ‰€æœ‰ snapdragon ä¸­
- æœ¬æ¬¡æ¼”è®²çš„ä¸»è¦ç„¦ç‚¹æ˜¯ç°ä»£å›½å®¶å’Œåˆ¶åº¦Qualcomm DIAG (QCDM) çš„å†…éƒ¨ç»“æ„ï¼Œä¸“æœ‰åŸºå¸¦ç®¡ç†å’Œè¯Šæ–­åè®®åŒ…å«åœ¨æ‰€æœ‰ Snapdragon SoC (SDxxx) ä¸Šçš„é«˜é€šåŸºå¸¦æ“ä½œç³»ç»Ÿä»¥åŠMDM/MSM/SDM èœ‚çªè°ƒåˆ¶è§£è°ƒå™¨èŠ¯ç‰‡
- ç°ä»£é«˜é€šèœ‚çªè°ƒåˆ¶è§£è°ƒå™¨åœ¨å®šåˆ¶ç¡…èƒ¶ä¸Šè¿è¡Œ(QDSP6) ä»¥åŠåä¸º Hexagon çš„ Qualcomm ä¸“æœ‰ ISAï¼Œæ‰€æœ‰ Qurt RTOS ä»£ç å‡ç”±å…¶ä¸­ç¼–å†™ï¼ŒåŒ…æ‹¬ DIAG å¤„ç†ç¨‹åºå’Œ OTA è½½ä½“
-  å¯¹åŸºå¸¦æ¼æ´è¿›è¡Œä¸€äº›æ¦‚æ‹¬æ€§æ¦‚è¿°ä¸ºé‚£äº›çœŸæ­£é˜…è¯»å¹»ç¯ç‰‡çš„äººè¿›è¡Œç ”ç©¶


- ![](pic/2024-01-15-22-51-20.png)
åœ¨è¿‡å»çš„ä¸‰å¹´é‡Œï¼Œæˆ‘è‡´åŠ›äºè™šæ‹ŸåŒ–å’Œç®¡ç†ç¨‹åºæ¼æ´çš„ç ”ç©¶å’Œåˆ©ç”¨
å¼€å‘äººå‘˜ã€‚ 2019 å¹´åˆï¼Œæˆ‘åˆšåˆšå®Œæˆäº†ä¸€ä¸ªå…³äº Microsoft Hyper-V [HYPERVISORS] çš„å°ç ”ç©¶é¡¹ç›®ï¼Œ
å¯¹è™šæ‹Ÿæœºç®¡ç†ç¨‹åºæ„Ÿåˆ°åŒå€¦ï¼Œå¹¶å¯»æ‰¾ä¸€äº›æ–°çš„ã€å…·æœ‰æŒ‘æˆ˜æ€§çš„ä¸œè¥¿æ¥è®©æˆ‘çš„å¤§è„‘æ€è€ƒ
çŸ­æœŸçš„å¹²æ‰°ã€‚
åŸºå¸¦é¢ä¸´çš„æŒ‘æˆ˜ä¸è™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„åŸå› ç›¸åŒï¼Œä½†ç¨‹åº¦æ›´å¤§ï¼š
æŠ€æœ¯å †æ ˆæå…¶å¹¿æ³›ä¸”å¤šæ ·ï¼›æ•°æ®æµè·¨è¶Šå¤šä¸ªæƒé™è¾¹ç•Œï¼›
æœ€ä½çº§åˆ«çš„æ“ä½œå¤„äºçº¯ç‰©ç†çš„è¾¹ç¼˜ï¼›è¶…ä½çº§è®¿é—®çš„ç»„åˆ
è¿œç¨‹æ— çº¿æ”»å‡»å‘é‡çš„è¦æ±‚ã€‚
åŸºå¸¦ä¸å…è®¸è¿›è¡Œçç¢çš„è°ƒè¯•å†…æ ¸ï¼Œè¿™å¯¹äºä½çº§é»‘å®¢æ¥è¯´æ˜¯ä¸€ä¸ªç«‹å³æœ‰è¶£çš„æŒ‘æˆ˜
åœ¨å¤§å¤šæ•°ç°ä»£ OTS å®ç°ä¸­ï¼ŒJTAG å·²èåˆï¼Œè€ŒåŸºå¸¦æ“ä½œç³»ç»Ÿåˆ™æ²¡æœ‰å¯¼å‡ºä»»ä½•å†…æ ¸è°ƒè¯•å·¥å…·ï¼ˆç±»ä¼¼äº iOSï¼‰
å¦å¤–ï¼Œæˆ‘æœ‰ä¸€ä¸ªæ—§çš„ USRP B100ï¼ˆåŸæ–‡å¦‚æ­¤ï¼ï¼‰ï¼Œæ¥è‡ªæˆ‘çš„é»‘å®¢ç©ºé—´åŸºç¡€æ—¶æœŸï¼Œéœ€è¦ä¸€äº›è‰¯å¥½çš„ä½¿ç”¨
è®©æˆ‘ä»¬å¼€å§‹å§


- ![](pic/2024-01-15-22-54-21.png)
- å®Œå…¨å¿½ç•¥äº†æœåŠ¡å™¨å› ç´ ï¼Œåªçœ‹ueç«¯

- ![](pic/2024-01-15-22-57-02.png)
- ä¸¤ä¸ªè¦ç‚¹
  - 1g2g3gä¸­çš„gä»…ä»…ä»£è¡¨ä¸åŒæŠ€æœ¯ä»£é™…ï¼Œå¯¹ç”¨æˆ·è€Œè¨€æ²¡æœ‰ä¸¥æ ¼æŠ€æœ¯å«ä¹‰
  - Air interfaceå³ç©ºå£åè®®æ˜¯æœ€åº•å±‚çš„åè®®ï¼Œè§„å®šèœ‚çªä¿¡å·ä¿¡å·å¦‚ä½•å‡†ç¡®åœ°æ•°å­—åŒ–å’Œä»ç”µç£æ³¢ä¸­è¯»å–ï¼Œä»¥åŠè¯¥é¢†åŸŸçš„ä¸åŒå‚ä¸è€…å¦‚ä½•å‡†ç¡®åœ°åˆ’åˆ†ç©ºé—´ï¼Œå†å²ä¸Šæœ‰ä¸¤ç§è¿™ç§ä½çº§åˆ«åè®®çš„ä¸¤ç§ä¸»è¦å®ç° tdmaå’Œcdma
    - è¡¥å…… å¤šå€æŠ€æœ¯åˆ†ä¸ºé¢‘åˆ†å¤šå€ï¼ˆFDMAï¼‰ã€æ—¶åˆ†å¤šå€ï¼ˆTDMAï¼‰ã€ç åˆ†å¤šå€ï¼ˆCDMAï¼‰ï¼Œå¯ä»¥è‡ªå·±æŸ¥è¯¢
    - cdmaç”±é«˜é€šå¼€å‘ï¼Œä¸»è¦ç”¨äºç¾å›½
  - 2gä¸­æœ‰ä¸¤ç§ä¸»è¦åè®® GSM(åŸºäºtdma) cdma oneï¼ˆåŸºäºcdmaï¼‰
  - 3gä¸­ä¸¤ä¸ªåˆ†æ”¯ç»§ç»­è¿›åŒ–ï¼Œgsmè¿›åŒ–ä¸ºUMTS , cdma oneè¿›åŒ–ä¸ºcdma2000ï¼Œæ³¨æ„æ­¤æ—¶gsmä¸­å·²ç»ä½¿ç”¨åˆ°äº†cdmaçš„ä½çº§ç©ºä¸­æ¥å£åè®®
  - 4gä¸­ä¸Šè¿°é‡åˆ†æ”¯å…±åŒå¼€å‘å‡ºlte
  - 5gä¹Ÿæ˜¯ç±»ä¼¼
  - ä¸Šè¿°ç©ºå£åè®®åœ¨æ‰€æœ‰åŸºå¸¦ä¸­éƒ½ä¼šå­˜åœ¨ï¼Œä¸”ä¸€å®šå­˜åœ¨å¯¹åº”çš„è§£æç®—æ³•ï¼Œè¿™æ˜¯æ”»å‡»é¢
  - åè®®ä¹‹é—´å¹¶ä¸æ˜¯å®Œå…¨ä¸åŒçš„ï¼ˆç”±äºè¿›åŒ–çš„è¿‡ç¨‹ï¼‰æ‰€ä»¥å¦‚æœä½ è€ƒè™‘ä¸€ä¸‹LTEï¼Œå®ƒå¹¶ä¸æ˜¯ä¸GSMå®Œå…¨ä¸åŒçš„åè®®ï¼Œè€Œæ˜¯å®ƒå¾ˆå¤§ç¨‹åº¦ä¸ŠåŸºäºç›¸åŒçš„å†…éƒ¨ç»“æ„ï¼Œäº‹å®ä¸Šï¼Œå¦‚æœä½ çœ‹ä¸€ä¸‹è§„èŒƒï¼Œå…¶ä¸­ä¸€äº›å‡ ä¹ä¸GSMçš„è§„èŒƒç›´æ¥ç›¸å…³

- ![](pic/2024-01-18-22-01-26.png)
- L3å±‚æ”»å‡»é¢æœ€æœ‰è¶£ï¼Œå› ä¸ºå…¶å¤„ç†äº†å¤§é‡é«˜çº§åè®®ï¼Œä¾‹å¦‚sms gsm ï¼Œå®é™…ä¸ŠåŒ…å«å¤„ç† tlb å€¼ç­‰æœ‰è¶£çš„æ•°æ®ç»“æ„çš„æ•°æ®ä»£ç 

- ![](pic/2024-01-18-22-07-10.png)
- åŸºæœ¬ä¸Šæ˜¯ap mpåˆ†å¼€åˆ†åˆ«è¿è¡Œå„è‡ªæ“ä½œç³»ç»Ÿ
- åŸºå¸¦å®ç°è¿‡ç¨‹ä¸­åŸºæœ¬ä¸Šéƒ½ä¼šå—åˆ°TEEä¿æŠ¤ï¼ˆå®‰å“ï¼šTrustZone è‹¹æœSEPOSï¼‰ï¼ŒåŸºäºæ­¤å³ä½¿è·å¾—apä¸­linuxå†…æ ¸çº§åˆ«æƒé™ï¼Œapä»æ— æ³•è®¿é—®åŸºå¸¦å†…å­˜æˆ–è¿›è¡Œç›¸å…³æ“ä½œï¼ŒåŒæ—¶ï¼ŒåŸºå¸¦ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®apï¼Œä¸¤è€…ç›¸äº’ä¸ä¿¡ä»»
- rtosä¸­ä¸‰ä¸ªæ”»å‡»é¢
  - èœ‚çªåè®®æ ˆ:ä¸€èˆ¬æ˜¯è¿è¡Œåœ¨rtosçš„å‡ ä¸ªä»»åŠ¡ä¸­
  - å¤§é‡ç®¡ç†åè®®ï¼š
    - ä¾‹å¦‚ATåè®®é€šå¸¸å­˜åœ¨äºæ‰€æœ‰åŸºå¸¦ä¸­ï¼Œç”šè‡³æš´éœ²ç»™apï¼Œä»è€Œç›´æ¥å‘apå‘å‘½ä»¤
    - ä¾‹å¦‚å‚å•†ç‰¹å®šçš„åè®®ï¼Œä¾‹å¦‚è¯Šæ–­åè®®ï¼Œç”±äºåŸºå¸¦æåº¦å¤æ‚ï¼Œæ•…ä¾›åº”å•†éœ€è¦ä¸“é—¨çš„åè®®è¿›è¡Œé…ç½®å’Œè¯Šæ–­
      - é«˜é€šä¸­diagæ˜¯ä¼—å¤šè¯Šæ–­åè®®ä¹‹ä¸€ï¼Œ
  - RTOS
    - å…¶ä¸­å®ç°çš„ä¸apæ¥å£çš„ä»£ç 
- apä¸­çš„æ”»å‡»é¢
  - socå¤–å›´è®¾å¤‡é©±åŠ¨
  - apä¸­ç”¨äºä¸åŸºå¸¦é€šè®¯çš„æ¥å£ ï¼ˆé«˜é€šä½¿ç”¨å…±äº«å†…å­˜ï¼Œéå¸¸å¤æ‚ï¼Œè¯¥å…±äº«å†…å­˜æ˜¯åŒæ–¹å…±åŒçš„æ”»å‡»é¢ï¼‰
- å¯ä¿¡ç¯å¢ƒçš„æ”»å‡»é¢,å› ä¸ºåŸºå¸¦è¿è¡Œåœ¨å¯ä¿¡ç¯å¢ƒä¸­ï¼Œæ‰€ä»¥å¯ä¿¡ç¯å¢ƒæ–¹é¢çš„é—®é¢˜ä¹Ÿæ˜¯ä¸€ä¸ªæ”»å‡»é¢
  - å®‰å…¨ç®¡ç†å™¨çš„è°ƒç”¨ç¨‹åºcall handlers è¯¥è°ƒç”¨ä¼šä»apåˆ°åŸºå¸¦
  - trustletï¼Œç”±TEEæ‰§è¡Œå’Œä¿æŠ¤çš„ç‹¬ç«‹ä»£ç ç‰‡æ®µã€‚
  
- ![](pic/2024-01-18-22-28-35.png)
  - èœ‚çªç½‘ç»œä¸­çš„æ•°æ®ç¼–è§£ç å™¨å¯ä»¥ç”±èœ‚çªå †æ ˆå®ç°ï¼Œä¹Ÿå¯ä»¥æœ‰rtoså®ç°ï¼Œç‰¹åˆ«æ˜¯asn1

- ![](pic/2024-01-18-22-29-00.png)
- ä¸Šè¿°æ”»å‡»é¢å·²ç»æœ‰äº†ä¸€äº›æˆæœ

- ![](pic/2024-01-18-22-32-35.png)
- æ³¨æ„sdrçš„é€šè®¯æŠ€æœ¯çš„å®ç°è½åäºæŠ€æœ¯çš„å‘å±•
- ç›®å‰ä¸å­˜åœ¨ç”¨äºå®ç°CDMAåŸºç«™çš„è½¯ä»¶å®ç°

- ![](pic/2024-01-18-22-50-06.png)
- é«˜é€šåŸºå¸¦ä¸ºä»€ä¹ˆéš¾
- QDSP6 / å…­è§’å½¢
â— é™Œç”Ÿçš„æ¶æ„
  â—‹ VLIWï¼Œæ¯”CPUæ›´æ¥è¿‘GPU
  â—‹ ä¸ x86/ARM/MIPS éå¸¸ä¸åŒ
â— æ— åç¼–è¯‘å™¨
  â—‹ åªèƒ½åæ±‡ç¼–
â— æ— QEMU å®Œæ•´ç³»ç»Ÿæ¨¡æ‹Ÿ
  â—‹ æƒ³è¦ï¼
â— æ— äºŒè¿›åˆ¶è¡¥ä¸å·®å¼‚
å¯¹æ¯”ã€‚
â—ä¸‰æ˜Ÿé¦™å†œï¼ˆä¸¾ä¾‹ï¼‰
  â—‹ æŒ‰éœ€å†…å­˜è½¬å‚¨ã€ä¸‹è½½å™¨æ¨¡å¼ï¼Œç†Ÿæ‚‰çš„æ¶æ„ï¼Œå¤§é‡æ—¥å¿—å­—ç¬¦ä¸²ã€åç¼–è¯‘å™¨ã€äºŒè¿›åˆ¶æ¯”è¾ƒ
â— è°ƒè¯•
  â—‹ ç°æˆçš„è®¾å¤‡å¸¦æœ‰å›ºåŒ–çš„ä¿é™©ä¸ï¼Œ
  â—‹ åŸºå¸¦ RTOS è¿è¡Œåœ¨å•ç‹¬çš„èŠ¯ç‰‡ï¼Œå— QSEE TrustZone ä¿æŠ¤
  â—‹ æ²¡æœ‰è°ƒè¯•ï¼Œæ²¡æœ‰æ•…éšœè½¬å‚¨ï¼Œä¸èƒ½è¯»å– mDSP å­˜å‚¨å™¨
â— é€†å‘å·¥ç¨‹
  â—‹ å·¨å¤§çš„äºŒè¿›åˆ¶æ–‡ä»¶
  â—‹ æ— è°ƒè¯•ç¬¦å·
  â—‹ æ™¦æ¶©çš„ RTOS
  â—‹ éƒ¨åˆ†ä»£ç è¢«å‹ç¼© /é‡å®šå‘
  â—‹ æ— æ—¥å¿—å­—ç¬¦ä¸²

- ![](pic/2024-01-18-22-38-58.png)
- æ—©æœŸé«˜é€šè¥é”€ææ–™ä¸­æœ‰æ­¤ç±»æ¶æ„å›¾ï¼Œç°åœ¨æ²¡æœ‰äº†
- é’ˆå¯¹Snapdragon 820Eçš„æ¡†æ¶ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¤„ç†å™¨ï¼ŒåŒ…æ‹¬
  - 4ä¸ªåŸºäºarmçš„cpuï¼Œä½œä¸ºap
  - adreno gpu
  - å¤šä¸ªhexagonå¤„ç†å™¨ï¼Œä¾‹å¦‚mdsp adsp cdsp

- ![](pic/2024-01-18-22-44-02.png)
- VLIW å¤šæ¡æŒ‡ä»¤å¯ä»¥åœ¨å•ç‹¬çš„æ‰§è¡Œå•å…ƒå¹¶è¡Œæ‰§è¡Œ
- åŒæ—¶ä½¿ç”¨äº†ç¡¬ä»¶å¤šçº¿ç¨‹å®ç°å¹¶è¡Œ
- ![](pic/2024-01-18-22-46-27.png)
- æ›´å¤šå…³äºhexagonï¼Œå‚ç…§æŒ‡å¯¼æ‰‹å†Œ
  - https://developer.qualcomm.com/download/hexagon/hexagon-v62-programmers-reference-manual.pdf
  - 80-n2040-36_b_hexagon_v62_prog_ref_manual.pdf


- ä¸ºä½•é«˜é€šè¦å¼€å‘hexagonæ¶æ„
- æŠ€æœ¯çš„æœªæ¥åœ¨äºä¼˜åŒ–æ•°å­—ä¿¡å·å¤„ç†ã€‚æ—¥ç›Šå¢é•¿çš„è¦æ±‚
VR å¸¦æ¥çš„å›¾å½¢ã€åœ¨çº¿æµåª’ä½“å¸¦æ¥çš„åª’ä½“ç¼–è§£ç å™¨ä¸æ–­å¢é•¿çš„éœ€æ±‚ã€äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰
ç¥ç»ç½‘ç»œå¤„ç†å’Œæ·±åº¦å­¦ä¹ ã€‚
å°¤å…¶æ˜¯äººå·¥æ™ºèƒ½ã€‚è¿™é¡¹æŠ€æœ¯æ­£ä»¥æƒŠäººçš„é€Ÿåº¦å‘å±•ï¼Œå¹¶å‘ˆç°å‡ºå¤šç§è¶‹åŠ¿
åŒæ—¶ã€‚å½“å‰çš„è¶‹åŠ¿ä¹‹ä¸€æ˜¯å°† ANN å¤„ç†å¸è½½åˆ°æœ€ç»ˆç”¨æˆ·è®¾å¤‡ï¼Œè€Œä¸æ˜¯
åœ¨äº‘ä¸­è¿è¡Œå®ƒã€‚è™½ç„¶å¯¹ä¸“ä¸šäººå·¥æ™ºèƒ½ç¡¬ä»¶çš„éœ€æ±‚å·²ç»å­˜åœ¨ä¸€æ®µæ—¶é—´äº†ï¼Œè€Œä¸”å¾ˆé«˜
åœ¨åœ°çƒä¸Šæ¯ä¸ªä¸»è¦èŠ¯ç‰‡ä¾›åº”å•†çš„è®®ç¨‹ä¸Šï¼›ä½†éšç€å¸è½½çš„è¶‹åŠ¿ï¼Œå®ƒè¿›ä¸€æ­¥
ç¼©å°åˆ°å¯¹ç´§å‡‘ä¸”å…·æœ‰æˆæœ¬æ•ˆç›Šçš„å¯æ’å…¥ä¸“ç”¨èŠ¯ç‰‡çš„è¦æ±‚
è¿›å…¥ç§»åŠ¨è®¾å¤‡ã€‚
æ·±åº¦å­¦ä¹ åœ¨å…·æœ‰æœ‰ç†æ•°çš„å·¨å¤§çŸ©é˜µä¸Šè¿è¡Œï¼Œå…¶ä¸­å¸¸è§çš„ CPU æ¶æ„
éå¸¸ç³Ÿç³•ã€‚ SIMD æ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚èŠ¯ç‰‡ç»„ä¾›åº”å•†å¼€å§‹è‡´åŠ›äºä¸“é—¨çš„ NPU æ¶æ„ï¼Œ
ä¸æ­¤åŒæ—¶ï¼Œè½¯ä»¶ä¾›åº”å•†è¿«äºå¸‚åœºéœ€æ±‚çš„å‹åŠ›ï¼Œè¢«è¿«åœ¨ GPU ä¸Šè¿è¡Œ ANNã€‚ä½†
GPU ä¸æ˜¯ä¸ºæ­¤è€Œè®¾è®¡çš„ã€‚ä»ç„¶éœ€è¦ä¸“é—¨çš„ç¡¬ä»¶æ¥å®ç°å…·æœ‰æˆæœ¬æ•ˆç›Šçš„äººå·¥ç¥ç»ç½‘ç»œæ“ä½œã€‚
ç»“æœï¼šHexagon ä½œä¸ºä¸€æ¬¾é’ˆå¯¹èœ‚çªç½‘ç»œçš„ä¸€ä½“åŒ–ã€ç»æµé«˜æ•ˆä¸”ä¼˜åŒ–çš„ DSPï¼Œå‡ ä¹æ²¡æœ‰ç«äº‰å¯¹æ‰‹
ä¿¡å·è½¬ç ã€ç¡¬ä»¶åŠ é€ŸéŸ³é¢‘å’Œè§†é¢‘ã€ä¼ æ„Ÿå™¨å¤„ç†å’Œäººå·¥æ™ºèƒ½

- ![](pic/2024-01-20-15-05-19.png)
- æ­£å¦‚æˆ‘æ‰€è¯´ï¼Œç”Ÿäº§ç†”æ–­çš„æ¦‚å¿µå¾ˆå¸¸è§ï¼Œä»¥å‰ç§»åŠ¨è®¾å¤‡ä¾›åº”å•†çš„å¸¸è§åšæ³•æ˜¯åœ¨è®¾å¤‡è¿›å…¥å¸‚åœºä¹‹å‰é”å®šè®¾å¤‡ï¼Œä»¥é˜²æ­¢ä¿®æ”¹å’Œä¿®è¡¥ï¼Œ
- ä¸ºå®ç°é”å®šï¼Œé€šå¸¸æ˜¯å°†å„ç§é«˜çº§è¯Šæ–­å’Œè°ƒè¯•åŠŸèƒ½ä»è½¯ä»¶æˆ–ç¡¬ä»¶ä¸­ç§»é™¤
- å¾ˆå¸¸è§çš„æ˜¯ï¼Œè¿™äº›åŠŸèƒ½ä»…ä»è½¯ä»¶ä¸­åˆ é™¤ï¼Œè€Œç¡¬ä»¶ä¿ç•™åœ¨è¿™é‡Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç ”ç©¶äººå‘˜æå‡ºä»–ä»¬è‡ªå·±çš„åŸºäºè½¯ä»¶çš„å®ç°ä»è€Œä½¿ç”¨æ­¤ç±»åŠŸèƒ½ï¼Œä¾‹å¦‚ä¸€äº›ioså†…æ ¸è°ƒè¯•å™¨ï¼Œåœ¨é«˜é€šçš„æƒ…å†µä¸‹ï¼Œåœ¨æŸä¸ªæ—¶å€™æœ‰ä¸€ä»½æ³„éœ²çš„å†…éƒ¨å¤‡å¿˜å½•ï¼Œå…¶ä¸­è®¨è®ºäº†ä»–ä»¬åœ¨ç”Ÿäº§èåˆè®¾å¤‡æ–¹é¢åˆ°åº•åšäº†ä»€ä¹ˆï¼Œ
  
- ![](pic/2024-01-20-15-10-55.png)
- åœ¨ç°ä»£çš„å®‰å“çš„ç”Ÿäº§ç†”æ–­ä¸­ï¼ŒåŸºå¸¦åœ¨basebandå†…è¿è¡Œï¼Œåœ¨æˆ‘çš„å®ç°ä¸­ï¼Œå®ƒå·²ç»è¢«å®Œå…¨é”å®šï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶ï¼ŒåŸºå¸¦ä½¿ç”¨ä¸€ä¸ªåä¸º mba çš„å•ç‹¬ç»„ä»¶ï¼Œå³è°ƒåˆ¶è§£è°ƒå™¨åŸºæœ¬èº«ä»½éªŒè¯å™¨ï¼Œæ•´ä¸ªäº‹æƒ…æ˜¯ç”±android å†…æ ¸çš„PILå­ç³»ç»Ÿè¿è¡Œçš„ï¼Œèƒ½æ‰¾åˆ°å…¶æºä»£ç å¹¶ç ”ç©¶å®ƒï¼Œ
- mbaç”¨äºéªŒè¯åŸºå¸¦ï¼Œæ•…æ— æ³•ä»»æ„æ³¨å…¥ä»£ç å¹¶åˆ·æ–°åˆ°åŸºå¸¦ï¼Œè¿™ä½¿å¾—æ³¨å…¥æ•°æ®åˆ°åŸºå¸¦å¾ˆå›°éš¾ï¼Œå”¯ä¸€çš„åŠæ³•æ˜¯åŸºäºæ¼æ´å»å®ç°


- ![](pic/2024-01-20-15-21-27.png)
å®‰å“MSM
  â— é‡‡ç”¨é«˜é€š SoC çš„ Android å†…æ ¸
  -ç‰¹å®šé©±åŠ¨ç¨‹åº
  â— CodeAurora å’Œ android/kernel/msm
å…±äº«å­˜å‚¨è®¾å¤‡
  â— é€šè®¯æ ¸å¿ƒæ¥å£å¸¦è°ƒåˆ¶è§£è°ƒå™¨çš„ Androidï¼ˆä¹Ÿè®¸æ›´å¤šï¼‰
QSEE
  â— é«˜é€šçš„TrustZoneå®ç°
  â— è°ƒåˆ¶è§£è°ƒå™¨ä½œä¸º trustlet è¿è¡Œ
hexagon SDK
  â— ä¾›å¼€å‘äººå‘˜ä½¿ç”¨çš„å·¥å…·å’Œæ ‡å¤´å…­è¾¹å½¢æ¶æ„
é¾™æ¿
  â— é¢å‘OEMçš„å¼€æ”¾å¼€å‘æ¿åŸå‹è®¾è®¡
Hexagon è¿è¡Œæ—¶åº“
  â— AP ç«¯å¯¹è¿è¡Œäºå…¶ä¸Šçš„ä»£ç çš„æ”¯æŒå…­è¾¹å½¢å¤„ç†å™¨


- ![](pic/2024-01-20-15-21-46.png)
- å›ºä»¶æå–
â— unify_trustlet
â— pymdt
åæ±‡ç¼–
â— å¤šä¸ª IDA Pro æ’ä»¶å¯ç”¨
  â—‹ GSMK
â— é€šè¿‡Hexagonè¿›è¡ŒåŸå§‹åæ±‡ç¼–è½¯ä»¶å¼€å‘å·¥å…·åŒ…
  â—‹ å¯¹è±¡è½¬å‚¨
â— mDSPï¼šç¼ºå°‘å…³é”®éƒ¨åˆ†OTAçŸ¢é‡ä»£ç ï¼ˆè§£å‹&åœ¨è¿è¡Œæ—¶é‡å®šä½ï¼‰
  â—‹ q6zip
é€†å‘å·¥ç¨‹åˆ†æ (mDSP)
â— ä»ä¸€äº›æ ¹ç‚¹å¼€å§‹
  â—‹ RTOS ä»»åŠ¡ç»“æ„
  â—‹ åˆ†é…åŸè¯­ï¼ˆå¾ˆå¤šï¼‰
â— IDA è„šæœ¬æ·»åŠ  Qshrinkâ€™edè°ƒè¯•æ—¥å¿—å­—ç¬¦ä¸²
  â—‹ ä¹‹åæ‚¨å¯ä»¥æ‰¾åˆ°æ„Ÿå…´è¶£çš„ä»£ç é€šè¿‡grep
è°ƒè¯•
â— æ²¡æœ‰å¼€ç®±å³ç”¨çš„
  â—‹ JTAG â€“ èåˆåœ¨ç”Ÿäº§è®¾å¤‡ä¸Š
  â—‹ Qcombbdbg â€“ ç”¨äºè¿‡æ—¶çš„ ARM å®ç°
  å…·æœ‰å¯ç”¨çš„ Diag R/W å‘½ä»¤
  â—‹ å¯èƒ½é€šè¿‡æ¼æ´åˆ©ç”¨

- ä»è°·æ­Œå®˜ç½‘ä¸‹è½½å›ºä»¶ï¼ˆOTAé•œåƒï¼‰ï¼Œæ‰¾åˆ°ä¸åŸºå¸¦ç›¸å…³çš„äºŒè¿›åˆ¶æ–‡ä»¶
  - https://developers.google.com/android/ota?hl=zh-cn#angler
- åŸºå¸¦ç›¸å…³å›ºä»¶è¢«åˆ†ä¸ºå¤šä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨unify_trustletå°†å…¶åˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶
- å¯ä»¥åŠ è½½åˆ°idaä¸­ï¼Œä½œè€…ä½¿ç”¨gsmkæ’ä»¶æ”¯æŒhexagonåæ±‡ç¼–
- åŸºå¸¦ä¸­éƒ¨åˆ†ä»£ç è¢«å‹ç¼©å’Œé‡å®šä½ï¼Œæ•…é™¤éè§£å‹ï¼Œå¦åˆ™æ— æ³•é™æ€åˆ†æï¼Œå…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºé«˜é€šä½¿ç”¨å†…éƒ¨çš„å‹ç¼©ç®—æ³•
- é€†å‘è¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹rtosï¼Œå…ˆå®šä½ä»»åŠ¡ç»“æ„ä½“ï¼Œä»¥æ­¤å®šä½æœ‰è¶£çš„å¤„ç†ä»£ç ï¼Œå¯¹äºhexagonï¼Œå…¶æ²¡æœ‰logå­—ç¬¦ä¸²ï¼Œæ•…æ¯”è¾ƒå›°éš¾ï¼Œå³ä½¿å®šä½åˆ°ä»»åŠ¡ç»“æ„ä½“ï¼Œå› ä¸ºæ²¡æœ‰logå­—ç¬¦ä¸²ï¼Œæ•…æ— æ³•ç¡®å®šå…¶ä»£ç åŠŸèƒ½
- é€†å‘åˆ†æç¬¬ä¸€æ­¥è¦æ¢å¤logå­—ç¬¦ä¸²ï¼Œlogå­—ç¬¦ä¸²è¢«qshrink4å·¥å…·ä»äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç§»é™¤ï¼Œå”¯ä¸€çš„æ¢å¤æ–¹å¼æ˜¯ä½¿ç”¨msg_hash.txtæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ¥è‡ªæ³„éœ²çš„é«˜é€šæºç ï¼Œæ­£å¸¸æ¥è¯´ä¸åº”è¯¥è¢«è·å–ï¼ˆå¤§å¤šæ•°æ—¥å¿—å­—ç¬¦ä¸²ç”±é“¾æ¥å™¨é˜¶æ®µåˆ é™¤
å·¥å…·Qshrink4ï¼Œæ›¿æ¢å¸¦æœ‰ MD5 å“ˆå¸Œå€¼ï¼‰
- logå­—ç¬¦ä¸²æ¢å¤æˆåŠŸåå¯ä»¥é‡å‘½åä¸€äº›å‡½æ•°ï¼Œå› ä¸ºlogå­—ç¬¦ä¸­å¸¸å¸¸åŒ…å«ä»£ç æºæ–‡ä»¶ã€æºæ¨¡å—çš„åç§°ï¼ˆæˆ‘çŸ¥é“åˆ°åœ¨å“ªé‡Œæ‰¾åˆ°é«˜é€šæ³„éœ²æºç ï¼Œå¥½åƒä¸‹è½½è¿‡ï¼‰
- è°ƒè¯•å¹¶éä¸å¯èƒ½ï¼Œä½†æ˜¯éœ€è¦å‡ ä¸ªæœˆçš„å·¥ä½œï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å»ºç«‹åŸºäºè½¯ä»¶çš„è°ƒè¯•å™¨å³ä¸€ä¸ªmodkitï¼ˆgongxilinå®ç°çš„ï¼ŒåŸºäºä¸€ä¸ªåŸºå¸¦è‡ªèº«æˆ–èº«ä»½éªŒè¯å™¨æˆ–trustzoneçš„è½¯ä»¶æ¼æ´ï¼‰ä»è€Œå°†ä»£ç æ³¨å…¥åŸºå¸¦ï¼Œå¹¶åœ¨è¿œç«¯è¿æ¥gdbè°ƒè¯•

- ![](pic/2024-01-20-16-14-09.png)
- å¤§å¤šæ•°æ—¥å¿—å­—ç¬¦ä¸²ç”±é“¾æ¥å™¨é˜¶æ®µåˆ é™¤å·¥å…·Qshrink4ï¼Œæ›¿æ¢å¸¦æœ‰ MD5 å“ˆå¸Œå€¼
- ä½¿ç”¨æ³„éœ²çš„æºç ä¸­çš„msg_hash.txtæ–‡ä»¶ å°†hashå€¼æ›¿æ¢

- ![](pic/2024-01-20-16-18-03.png)
- æ¢å¤logå­—ç¬¦ä¸²å¹¶é‡å‘½åå‡½æ•°åï¼Œå¯ä»¥å¾—åˆ°æ•°ç™¾ä¸ªdiagç›¸å…³çš„å‡½æ•°
- ä¹Ÿå¯ä»¥å¾—åˆ°OTAç›¸å…³å‡½æ•°ï¼Œä½†æ­¤ç±»å‡½æ•°ç»å¤§å¤šæ•°ä½äºç‰¹å®šæ®µä¸­ï¼Œè¯¥æ®µæ•°æ®è¢«å‹ç¼©å’Œé‡å®šä½ï¼Œæ— æ³•é™æ€åˆ†æ

- ![](pic/2024-01-20-16-22-58.png)
é¡¹ç›®ä¸­æœŸåæ€
å¯¹äº 1 ä¸ªæœˆçš„é¡¹ç›®æ¥è¯´å¤ªéš¾äº†ï¼›ä¸¥é‡çš„vulndevæ˜¯ä¸å¯èƒ½çš„
æˆ‘è¿˜èƒ½åœ¨è§„å®šçš„æ—¶é—´å†…åšå‡ºä¸€äº›æœ‰è¶£ä¸”æœ‰ç”¨çš„ä¸œè¥¿å—
åˆ†é…ï¼Ÿ
ä¹Ÿè®¸å¯ç”¨è°ƒè¯•æ—¥å¿—è®°å½•ï¼Ÿä½¿ç”¨æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œè€Œä¸ä»…ä»…æ˜¯åè®®
è½¬å‚¨ã€‚çœ‹çœ‹åŸºå¸¦åˆ°åº•åœ¨åšä»€ä¹ˆåº”è¯¥å¾ˆæœ‰è¶£ï¼Œå¹¶ä¸”
è¿™å¹¶ä¸ç®€å•ï¼Œå› ä¸ºæ—¥å¿—å­—ç¬¦ä¸²è¢«å‰¥ç¦»äº†
å¦å¤–ï¼šramdump

- ![](pic/2024-01-20-16-23-21.png)
æ„å»ºå¹¶åˆ·æ–° Android MSM å†…æ ¸ âœ…
  â— æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåªæ˜¯ä¸€ä¸ªå¸¸è§„çš„äº¤å‰æ„å»º
å›ºä»¶é™çº§âœ…
  â— çç¢
æ„å»º qcom å›ºä»¶ âš 
  â— æ—¶é—´ä¸å¤Ÿäº†ï¼Œå¯èƒ½æ˜¯é”™è¯¯çš„æ¥æº
  â— æœ‰äººåˆšåˆšåœ¨ç§ä¸‹è°ˆè¯ä¸­è¯å®è¿™æ˜¯å¯èƒ½çš„ï¼Œä¼šå†è¯•ä¸€æ¬¡
å†…å­˜è½¬å‚¨ ğŸš«
  â— AP å†…æ ¸å›è°ƒä¸å­˜åœ¨ +äº§å“èåˆï¼Ÿ
Shady Q* è¯Šæ–­å·¥å…· âŒ
  â— QPSTã€QXDM ç­‰ã€‚
  â— è·³è¿‡æ­¤éƒ¨åˆ†
é¾™æ¿âŒ
  â— ä¿å­˜ä»¥ä¾›ç¨åä½¿ç”¨ï¼ˆä¹Ÿè®¸ï¼‰
  â— å¯¹äºæ¼æ´åˆ©ç”¨å¼€å‘ï¼Œæ‚¨éœ€è¦è°ƒè¯•è¢«æ”»å‡»çš„å®é™…è®¾å¤‡ï¼Œè€Œä¸æ˜¯ä¸€äº›æŠ½è±¡çš„é«˜é€šè°ƒåˆ¶è§£è°ƒå™¨èŠ¯ç‰‡
åŠ³ç‰¹å·´èµ«è°ƒè¯•å™¨ âš 
  â— å¯¹äºäº§å“è®¾å¤‡æ— ç”¨ï¼Œå·²è·³è¿‡
  â— å°†å†æ¬¡æ£€æŸ¥æˆ‘æ˜¯å¦å¯ä»¥ç»•è¿‡JTAGç†”æ–­
- æˆåŠŸäº¤å‰ç¼–è¯‘msmå†…æ ¸
- å›ºä»¶å’ŒåŸºå¸¦çš„é™çº§æ”»å‡»ä¸€å®šæ˜¯æœ‰æ•ˆçš„
- é€šè¿‡æ³„éœ²ä»£ç æ„å»ºäº†é«˜é€šå›ºä»¶

- ![](pic/2024-01-20-21-30-37.png)
  - è°ƒè¯•æ—¥å¿—è®°å½•ä½äºäºŒè¿›åˆ¶ä»£ç ä¸­ï¼Œè‚¯å®šä»¥æŸç§æ–¹å¼ä½¿ç”¨äº†å®ƒå—ï¼Ÿ
  - å¯ä»¥å¯ç”¨é€‰æ‹©åŠ å…¥å—ï¼Ÿå®ƒå°†ç™»å½•åˆ°å“ªé‡Œï¼Ÿæ˜¯å¦å¯¼å‡ºåˆ°Androidæ ¸å¿ƒï¼Ÿ
  - DIAG åè®®å¯¹äºé…ç½®æ¥è¯´ä¼¼ä¹å¾ˆå¼ºå¤§ï¼Œè¿™å¯èƒ½æ˜¯ç­”æ¡ˆå—ï¼Ÿ

- ![](pic/2024-01-20-21-31-02.png)
æ¦‚è¿°
â— Qualcomm ä¸“æœ‰åè®® èœ‚çªè°ƒåˆ¶è§£è°ƒå™¨ RTOS ç®¡ç†
â— ä¸ QMI å’Œå…¶ä»–Q åè®®ä¸€èµ·
â— ç†è®ºä¸Šçº¦ 200 ä¸ªå‘½ä»¤
å†å²
â— Libqcdm/ModemManager
  â—‹ ~2010å¹´ï¼Œéƒ¨åˆ†é€†å‘
â— CCC2011ï¼Œçºªå°§å§†Â·å¾·å•æ ¼é›·
  â—‹ Diagæ¶ˆæ¯æ ¼å¼+HDLC
  â—‹ ä¸€äº›æœ‰è¶£çš„å‘½ä»¤
  â—‹ å¤§éƒ¨åˆ†ä¸åŸºå¸¦æ— å…³
åº”ç”¨é¢†åŸŸ
  â— OEM å¼€å‘äººå‘˜çš„é«˜çº§è°ƒè¯•
  â— åŸºå¸¦å›ºä»¶é‡é…ç½®
  â—ï¼ˆå·²è¿‡æ—¶ï¼‰å¼ºå¤§çš„è¯Šæ–­å·¥å…·:ä¾‹å¦‚ä¸‹è½½æ¨¡å¼ã€ç›´æ’­æ¨¡å¼ã€è½¬å‚¨ã€å†…å­˜è¯»/å†™
è¿›æ”»è§†è§’
  â— æ¥è‡ªAP çš„æœ¬åœ°EoP æ”»å‡»å‘é‡ apå†…æ ¸åˆ°åŸºå¸¦ RTOS
â— å¸¸è§åœºæ™¯ï¼šç§»åŠ¨è¿è¥å•†è§£é”æ¼æ´
â— åœºæ™¯#2ï¼šåˆ©ç”¨è¯¥æ¼æ´å¯ç”¨è‡ªå®šä¹‰è½¯ä»¶è°ƒè¯•å™¨æ³¨å…¥

- çªç„¶è±¡åˆ°éƒ¨åˆ†pptå’Œç™½çš®ä¹¦ä¸­è®²åˆ°diagåè®®ï¼Œä¼¼ä¹è¯¥åè®®å¾ˆå¼ºå¤§ï¼Œå¯ä»¥ç”¨äºé‡æ–°é…ç½®åŸºå¸¦
- å°è¯•ä½¿ç”¨åè®®å¼€å¯logè½¬å‚¨åŠŸèƒ½
- Qualcomm Diag / QCDM æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œç”¨äºé«˜çº§åŸºå¸¦è½¯ä»¶é…ç½®å’Œè¯Šæ–­
- ä¸»è¦é’ˆå¯¹OEMå¼€å‘
- ç†è®ºä¸Šè‡³å°‘æ”¯æŒ200å¤šä¸ªå‘½ä»¤ï¼Œæ ¹æ®èµ„æ–™ï¼Œç”šè‡³æ”¯æŒdownloadæ¨¡å¼å’Œè¯»å†™å†…å­˜
- diagåœ¨2010å¹´è¢«é€†å‘ï¼Œä¸”è¢«åŒ…å«åœ¨è°ƒåˆ¶è§£è°ƒå™¨ç®¡ç†å™¨ï¼ˆModemManagerï¼‰çš„å¼€æºé¡¹ç›®ä¸­
- å®ƒä¹Ÿè¢« åœ¨ guillain-barre ä¸¾åŠçš„ 2011 å¹´é€šä¿¡å¤§ä¼šä¸Šçš„æ¼”è®²ä¸­å±•ç¤ºï¼Œä½†æ˜¯ç›¸å…³ä¿¡æ¯ä¸è®¾å¤‡åŸºå¸¦ä¸ç›¸å…³ï¼Œä»£è¡¨äº†åº”ç”¨ç¨‹åºå¤„ç†å™¨åˆ°åŸºå¸¦æœ¬åœ°æ”»å‡»å‘é‡ï¼Œ
- è¯¥åè®®å¸¸ç”¨äºå°†é”å®šäºç‰¹å®šç§»åŠ¨æœåŠ¡çš„æ‰‹æœºè®¾å¤‡è¿›è¡Œè§£é”ï¼Œåœ¨ç›´æ¥åè®®ä¸­å‘ç°å†…å­˜æŸåæ¼æ´ï¼Œåˆ™å¯ä»¥ç›´æ¥åœ¨åŸºå¸¦ä¸Šæ‰§è¡Œä»£ç å¹¶æ›´æ”¹ä¸€äº›è®¾ç½®ï¼Œè¿™é€šå¸¸æ˜¯é€šè¿‡ 80 ä¸ªé€šç”¨å¤„ç†ç¨‹åºå®Œæˆçš„ï¼Œä½†å†…éƒ¨ ä¸“æœ‰åè®®ä¹Ÿéå¸¸æ–¹ä¾¿
- æ­¤å¤–è¯¥åè®®å¯ä»¥ç”¨äºæ³¨å…¥åŸºäºè½¯ä»¶çš„è°ƒè¯•å™¨ï¼Œè‹¥èƒ½åœ¨diagä¸­å‘ç°å†…å­˜è¯»å†™ç›¸å…³æ¼æ´ï¼Œå¯ä»¥æ³¨å…¥hookä»£ç ï¼Œæœ€ç»ˆè¿æ¥åˆ°gdbï¼Œè¿™æ ·å³ä½¿jtagä¸å¯ç”¨ï¼Œä¹Ÿèƒ½è°ƒè¯•


- ![](pic/2024-01-20-21-48-43.png)
å…¬å¼€ä¿¡æ¯
  â— åŸºäºARM
  â— å®æ—¶æ“ä½œç³»ç»ŸREX
  â— ä¸‹è½½å™¨æ¨¡å¼*
  â— å­˜å‚¨å™¨è¯»/å†™å‘½ä»¤*
  â— å®æ—¶å¿«ç…§*
  â— ç›´æ¥è®¿é—®é€šé“USB*
--
* å¯èƒ½ä»ç„¶ä¸ä¸çŸ¥åçš„ OEM è®¾å¤‡ç›¸å…³ï¼Œè¯¥è®¾å¤‡ç”¨äºQualcomm MDM/MSM èŠ¯ç‰‡ä¸Š
å½“å‰çŠ¶æ€
â— åŸºäºQDSP6/Hexagon
â— å®æ—¶æ“ä½œç³»ç»Ÿ QuRT
â— æ— ä¸‹è½½å™¨æ¨¡å¼*
â— æ— å†…å­˜RW*
â— æ— å®æ—¶å¿«ç…§*
â— æ— USBé€šé“*
â—‹ å¯ä»¥åœ¨æŸäº›ï¼ˆï¼Ÿï¼‰ä¸Šé€šè¿‡bootè®¾ç½®å¯åŠ¨ï¼Ÿï¼Ÿï¼Ÿ
--
* ä¸ç°ä»£ç”Ÿäº§è®¾å¤‡ç›¸å…³ï¼ˆåœ¨ Nexus 6P ä¸Šæµ‹è¯•ï¼Œé¢„è®¡åœ¨ Google pixelå’Œå…¶ä»–ä¸€åˆ‡ä¸Šéƒ½æ˜¯ç”¨ï¼‰
- å†å²ä¸Šé«˜é€šåŸºå¸¦åŸºäºarm æ“ä½œç³»ç»Ÿä¸ºrexï¼Œä¸”diagæ”¯æŒå¤šç§å‘½ä»¤æ¨¡å¼ï¼Œç°åœ¨é«˜é€šåŸºå¸¦åŸºäºhexagonï¼Œ ä½¿ç”¨qurtä½œä¸ºç³»ç»Ÿï¼Œdiagé«˜çº§å‘½ä»¤è¢«åˆ é™¤ï¼Œä¸”ä¸æš´éœ²å¯è¿æ¥çš„æ¥å£ï¼ˆusbï¼‰ï¼‰ï¼ˆä¼¼ä¹é€šè¿‡æ·»åŠ ç‰¹å®šbootè®¾ç½®å¯ä»¥å¼€å¯usbè¿æ¥ï¼‰
- ä½œè€…ç ”ç©¶åŸºäºnexus 6p ï¼Œå±äºä¸­ç­‰é˜²æŠ¤ï¼Œpixelç­‰æ›´æ›´ç°ä»£çš„è®¾å¤‡æœ‰æ›´é«˜çº§çš„é˜²æŠ¤ï¼Œé€šè¿‡æ˜¯ä¸€äº›æ— åè®¾å¤‡ä¾‹å¦‚å¼€æºè°ƒåˆ¶è§£è°ƒæ£’å¯èƒ½æ›´å®¹æ˜“è°ƒè¯•

- ![](pic/2024-01-20-22-02-24.png)
- å·¦è¾¹æ˜¯å®‰å“ç³»ç»Ÿï¼Œå³è¾¹æ˜¯åŸºå¸¦ç³»ç»Ÿ
- diagä¸ä»…ä»…apå¯ä»¥å‘é€å‘½ä»¤åˆ°åŸºå¸¦ï¼ŒåŸºå¸¦ä¹Ÿå¯ä»¥ç»™apå‘é€æ¶ˆæ¯
- å®ƒä»¬çš„å‘½ä»¤å¹¶ä¸æ˜¯çœŸæ­£çš„å‘½ä»¤ï¼Œå®ƒä»¬æ›´åƒæ˜¯ä»¤ç‰Œï¼Œä¹Ÿå¯ç”¨äºå¯¹æ¶ˆæ¯è¿›è¡Œç¼–ç ã€‚
- ç»¿ç®­å¤´è¡¨ç¤ºä¸€ä¸ªåŸºå¸¦åˆ°apçš„æ•°æ®æµ
- åŸºå¸¦ä¸­diag taskç”¨äºç®¡ç†diagï¼Œç”¨äºå¤„ç†äºdiagåè®®ç›¸å…³çš„å„ç§æ“ä½œ
- diagä»»åŠ¡ä¸å…¶ä»–ä»»åŠ¡ä¹‹é—´ä½¿ç”¨ring bufferäº¤äº’
- åœ¨logè¾“å‡ºçš„ä¾‹å­ä¸­ï¼Œå…¶ä»–ä»»åŠ¡é€šè¿‡è°ƒç”¨æŒ‡å®šapiå°†logä¿¡æ¯è¾“å…¥ring buf ï¼Œdiagä»»åŠ¡ä»ring bufä¸­å–å‡ºæ•°æ®ï¼ˆé€šè¿‡è½¯ä¸­æ–­æˆ–å®šæ—¶å™¨ï¼‰ï¼Œæ­¤æ—¶æ•°æ®å°†è¢«åŒ…è£…åˆ° dia åè®®ä¸­ï¼Œä»é‚£é‡Œå®ƒå°†å‘é€åˆ°SIO ä»»åŠ¡ä¸­ï¼ˆè´Ÿè´£ä¸²å£ioï¼‰ï¼Œå¹¶å‘é€åˆ°ç‰¹å®šæ¥å£
- å½“å‰æ­£åœ¨ç ”ç©¶ä½äºå®‰å“å†…æ ¸ä¸­diagcharé©±åŠ¨çš„å…±äº«å†…å­˜
- apå‘åŸºå¸¦å‘é€æ•°æ®çš„è¿‡ç¨‹ä¸ä¸Šè¿°ç›¸å
  - åˆ¶é€ diagæ•°æ®åŒ…å‘é€ç»™diagé©±åŠ¨ï¼Œé©±åŠ¨å°†æ•°æ®å†™å…¥å…±äº«å†…å­˜ï¼Œä»é‚£é‡Œæ•°æ®è¿›å…¥åŸºå¸¦ç‰¹å®šçš„ä»»åŠ¡
  
- ![](pic/2024-01-20-23-16-11.png)
æ¦‚è¿° 
  â— diagchar + diagfwd å†…æ ¸é©±åŠ¨ç¨‹åº é«˜é€š MSM Android å†…æ ¸
åŠŸèƒ½ 
  â— æ”¯æŒDiag æ¥å£ â— å¤šè·¯Diag é€šé“åˆ°USB æˆ–å†…å­˜è®¾å¤‡
  â— åˆ°ç”¨æˆ·åŒºçš„ IOCTL æ¥å£ â— å±è”½ä¸å¿…è¦çš„ Diag å‘½ä»¤
å®ç°æ–¹å¼ 
  â— åŸºäºSMD/SMEMå…±äº«å†…å­˜è®¾å¤‡ï¼ˆMSM ç‰¹å®šï¼‰
- å®‰å“ä¸­/dev/diagè¡¨ç¤ºdiag
- diagcharé©±åŠ¨ç”¨äºæ”¯æŒdiagæ¥å£ï¼Œä»£ç å¾ˆå¤æ‚ï¼Œä½†åŠŸèƒ½å¾ˆç®€å•ï¼ŒåŒ…æ‹¬ä¸€äº›åœ¨åŸºå¸¦ä¸­å¯ä»¥é…ç½®çš„åŸºæœ¬diagå‘½ä»¤ï¼Œèƒ½å¤Ÿå°†diagä¿¡é“é€šé“å¤šè·¯å¤ç”¨åˆ° USB æˆ–å†…å­˜è®¾å¤‡ï¼Œå®ƒè¿˜åŒ…å«ä¸€äº›ioctlè¯¦ç»†ä¿¡æ¯ï¼Œç”¨äºå¯ä»¥ä»androidç”¨æˆ·ç•Œé¢è®¿é—®çš„é…ç½®
- é©±åŠ¨ä¸­åˆ é™¤äº†éƒ¨åˆ†å‘½ä»¤ï¼Œå½“æ‚¨éœ€è¦å‘é€ç‰¹å®šdiagå‘½ä»¤æ—¶ï¼Œéœ€è¦é‡å»ºdiagé©±åŠ¨ä»è€Œåˆ é™¤å…¶ä¸­çš„å±è”½ï¼Œå¦åˆ™å‘½ä»¤ä¸ä¼šåˆ°è¾¾åŸºå¸¦ä¾§
- æ ¸å¿ƒdiagé©±åŠ¨åŸºäºsmbå…±äº«å†…å­˜æ¥å£ï¼Œè¯¥æ¥å£æ˜¯é«˜é€šåŸºå¸¦çš„æ ¸å¿ƒæ¥å£

- ![](pic/2024-01-20-23-31-03.png)
- diagçš„å®é™…ä½ç½®ï¼Œå³ä½äºç®¡ç†åè®®çš„ä½ç½®
- diagé©±åŠ¨ä½äºapï¼Œæ˜¯å‚å•†ç‰¹å®šçš„é©±åŠ¨ï¼ŒåŸºå¸¦ä¸­æœ‰ä¸€äº›å…±äº«å†…å­˜çš„å®ç°ç”¨äºå¤„ç†diagï¼ŒåŸºå¸¦ä¸­è¿˜æœ‰diagçš„å®ç°æœ¬èº«

- ![](pic/2024-01-20-23-34-35.png)
- diagcharé©±åŠ¨ç”¨äºæ”¯æŒdiagæ¥å£ï¼Œä»£ç å¾ˆå¤æ‚ï¼Œä½†åŠŸèƒ½å¾ˆç®€å•
- å®ƒç¡®å®å®ç°äº†ä¸€äº›ioctlï¼Œè¿™äº›ioctlå¯ç”¨äº†ä¸€äº›é…ç½®ï¼Œè¿˜æœªæ£€æŸ¥è¯¥ioctlå…·ä½“åšä»€ä¹ˆï¼Œè¿™äº›ioctlæš´éœ²äº†/dev/diagè®¾å¤‡ï¼Œä»¥å¯å†™çš„æ–¹å¼

- ![](pic/2024-01-20-23-39-30.png)
- é»˜è®¤æƒ…å†µä¸‹æ— æ³•è®¿é—®diagä¿¡é“ï¼Œå› ä¸ºå­˜åœ¨diag_switch_loggingå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä¿¡é“åˆ‡æ¢åˆ°ç”¨äºdiagé€šè®¯çš„ä¿¡é“ diag_switch_loggingå‡½æ•°æœ‰å¾ˆå¤šæ¨¡å¼ï¼Œä½†å®é™…ä¸Šä»…æ”¯æŒusbæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰å’Œå…±äº«å†…å­˜è®¾å¤‡æ¨¡å¼
- è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¦‚æœæ‚¨åªæ˜¯æ‰“å¼€è®¾å¤‡diagé©±åŠ¨ç¨‹åºå¹¶å°è¯•ä»ä¸­è¯»å–æŸäº›å†…å®¹ï¼Œå®ƒå°†æ— æ³•å·¥ä½œï¼Œå®ƒä¼šè¢«æŸç¼šåˆ° USBï¼Œä¸ºäº†é‡æ–°é…ç½®å®ƒä»¥ä½¿ç”¨å­˜å‚¨è®¾å¤‡ï¼Œæ‚¨éœ€è¦å‘é€ä¸€ä¸ªç‰¹æ®Šçš„ioctl ä»£ç ï¼Œè¯¥è¿‡ç¨‹ç§°ä¸ºåç§°æ©ç è¯·æ±‚éªŒè¯ï¼Œå®ƒå¯¹æ‚¨å°è¯•é€šè¿‡æ­¤æ¥å£å‘é€çš„å‘½ä»¤é‡‡ç”¨ç›¸å½“ä¸¥æ ¼çš„è¿‡æ»¤ï¼Œå› æ­¤å®ƒä¼šè¿‡æ»¤å¤§å¤šæ•°æ ¸å¿ƒè¯·æ±‚ï¼Œé™¤äº†ä¸€äº›åŸºæœ¬é…ç½®è¯·æ±‚

- ![](pic/2024-01-20-23-50-48.png)
- æ ¸å¿ƒdiagé©±åŠ¨ä½¿ç”¨å…±äº«å†…å­˜è®¾å¤‡ä¸åŸºå¸¦é€šè®¯ï¼Œsmdå®ç°ååˆ†å¤æ‚ï¼Œå®ƒå…¬å¼€äº† smd è¯»å–apiï¼Œå®é™…ä½¿ç”¨è¯¥APIç”¨äºä»å…±äº«å†…å­˜è¯»å–æ•°æ®
- å…±äº«å†…å­˜çš„ä¸€ä¸ªapiä¹Ÿå¯¹é€šé“çš„é˜»å¡è¿›è¡Œæ“ä½œï¼Œè¿™äº›é€šé“æ˜¯é€šè¿‡åä¸ºsmdçš„apiåä¸ºopen an edgeè®¿é—®çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸€äº›ç›´æ¥å¯ä»¥æ‰“å¼€çš„ç‰¹å®šé€šé“

- ![](pic/2024-01-20-23-59-46.png)
- ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ åœ¨ smdå®ç°ä¸­ï¼Œè¿™æœ‰ç‚¹é‡è¦ï¼Œå› ä¸ºå…±äº«å†…å­˜è®¾å¤‡ä»£è¡¨ä»è°ƒåˆ¶è§£è°ƒå™¨å‡çº§åˆ°åº”ç”¨ç¨‹åºå¤„ç†å™¨çš„æ”»å‡»é¢çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ”»å‡»é¢ï¼Œå› ä¸ºå¦‚æœæ‚¨åªæ˜¯åœ¨åŸºå¸¦å®ç°ä»£ç æ‰§è¡Œï¼Œé‚£ä¹ˆå®ƒå‡ ä¹æ¯«æ— ç”¨å¤„å› ä¸ºå®ƒæ— æ³•è®¿é—®ä¸»æ“ä½œç³»ç»Ÿï¼Œä¸ºäº†ä½¿å…¶æœ‰ç”¨ï¼Œæ‚¨éœ€è¦å°†å®ƒä»¬é“¾æ¥èµ·æ¥ä»¥åˆ›å»ºä¸€ä¸ªæ¼æ´åˆ©ç”¨é“¾ï¼Œå¹¶ä¸”åŸºäºè¯¥å—çš„å¦ä¸€ä¸ªæ¼æ´åˆ©ç”¨
- ç»¼ä¸Šå†…å­˜å…±äº«è®¾å¤‡æ˜¯å®ç°ä»åŸºå¸¦åˆ°apææƒçš„æ”»å‡»é¢

- ![](pic/2024-01-21-13-51-01.png)
- å…±äº«å†…å­˜è®¾å¤‡çš„å®ç°ç”±é«˜é€šå¤–è®¾æš´éœ²å‡ºæ¥ï¼Œä¸“é—¨çš„ msn é©±åŠ¨ç¨‹åºå°†æ˜ å°„å®ƒï¼Œé©±åŠ¨ç¨‹åºåä¸ºsmem_ram_physï¼Œè¯¥é©±åŠ¨æ˜¯å…±äº«å†…å­˜çš„åŸºç¡€

- ![](pic/2024-01-21-13-55-40.png)
- å…±äº«å†…å­˜åŒºåŸŸåŸºäºæ¡ç›®å’Œé€šé“çš„æ¦‚å¿µè¿›è¡Œæ“ä½œï¼Œå…¶è¢«åˆ†ä¸ºè¿œç¨‹éƒ¨åˆ†ï¼ˆå¯ä»¥é€šè¿‡smem_get_entryç¨‹åºè®¿é—®ï¼‰
- å…¶ä¸­ä¸€ä¸ªæ¡ç›®æ˜¯smem_channel_alloc_tblï¼Œå…¶ä¸­åŒ…æ‹¬äº†å¯æ‰“å¼€çš„å¯ç”¨é€šé“åˆ—è¡¨ï¼Œä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€channelå¹¶ä¸”ä½¿ç”¨å†…å­˜å…±äº«æ¥å£


- ![](pic/2024-01-21-14-04-39.png)
- ç ”ç©¶æ•´ä¸ªé«˜é€šç”Ÿæ€ç³»ç»Ÿå¹¶ä¸æ˜¯æˆ‘çš„ç›®æ ‡ï¼Œæ‰€ä»¥å½“æˆ‘å‡†å¤‡è¿™æ¬¡æ¼”è®²æ—¶ï¼Œæˆ‘æ³¨æ„åˆ°æºä»£ç ä¸­ä¸€äº›æ›´æœ‰è¶£çš„äº‹æƒ…ï¼Œä¾‹å¦‚å¤„ç†jtagçš„é©±åŠ¨ç¨‹åºï¼Œè¯¥é©±åŠ¨ä¼¼ä¹ç”±é«˜é€šç³»ç»Ÿä¸­æŸäº›èŠ¯ç‰‡æ‰€æš´éœ²ï¼Œä»é©±åŠ¨æ¥çœ‹ï¼Œä¸»è¦ç”¨äºè¯»æ•°æ®ï¼Œä½œè€…ä¸è®¤ä¸ºå¯ä»¥å†™æ•°æ®ï¼Œä¸è¿‡å€¼å¾—æ£€æŸ¥


- ![](pic/2024-01-21-14-10-21.png)
- â— SnoopSnitchï¼ˆå¼€æºï¼‰ â— å¯ä»¥åœ¨ root è®¾å¤‡ä¸Šå¯ç”¨åè®®è½¬å‚¨ â— é€šè¿‡åˆ©ç”¨çš„ /dev/diag æ¥å£å‘é€æ¨¡ç³Šçš„ QCDM å‘½ä»¤ blob ğŸ‘‰ğŸ» â— æ›´æ”¹åŸºå¸¦å›ºä»¶é…ç½® â— æ‚¨èƒ½è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ blob å¯¹æ‚¨çš„æ‰‹æœºåˆ°åº•åšäº†ä»€ä¹ˆå—ç”µè¯ï¼Ÿ â— æˆ‘å¾ˆå¥½å¥‡
- diagåè®®è¢«ç”¨åœ¨å¾ˆå¤šå…¶ä»–å¼€æºé¡¹ç›®ä¸­ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¹‹å‰è¯´çš„Libqcdm
- SnoopSnitch (open source) è¯¥å·¥å…· Can enable protocol dumps on rooted devices
- ä¸ºå®ç°åè®®dump è¯¥å·¥å…·å‘é€ blobæ•°æ®(åŒ…å«diagå‘½ä»¤)åˆ°/dev/diagæ¥å£ï¼Œè¿™ä¸ªå—æ˜¯æ­£å¸¸çš„æ²¡æœ‰è®°å½•æ‰€ä»¥è¿™è®©æˆ‘å¾ˆå¥½å¥‡è¿™äº›å‘½ä»¤åˆ°åº•åœ¨åšä»€ä¹ˆ

- ![](pic/2024-01-21-14-16-44.png)
- ä½†æ˜¯åœ¨æˆ‘ä»¬æŸ¥çœ‹è½¬å‚¨ä¹‹å‰è®©æˆ‘ä»¬äº†è§£åè®®ï¼ŒDiag åè®®ç”±å¤§çº¦ 200 ä¸ªå‘½ä»¤æˆ–ä»¤ç‰Œç»„æˆï¼Œå…¶ä¸­ä¸€äº›å·²åœ¨å¼€æºä¸­è®°å½•ï¼Œä½†ä¸æ˜¯å…¨éƒ¨ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨å±å¹•æˆªå›¾ä¸­æ³¨æ„åˆ°ä¸€äº›æ³¨é‡Šä¸¢å¤±ï¼Œå…¶ä¸­ä¸¢å¤±çš„æ³¨é‡Šä¹‹ä¸€å®é™…ä¸Šæ˜¯åå…­è¿›åˆ¶çš„ä»¤ç‰Œï¼Œå®ƒè¡¨ç¤ºç¼–ç çš„å“ˆå¸Œæ—¥å¿—æ¶ˆæ¯

- ![](pic/2024-01-21-14-20-17.png)
- é€šç”¨æ ¼å¼éå¸¸ç®€å•ï¼Œå…¶åŸºæœ¬åŸè¯­æ˜¯diagä»¤ç‰Œç¼–å·0x7eï¼Œå®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„åˆ†éš”ç¬¦ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ç‹¬çš„diagå‘½ä»¤(0x7eå³126) å¼€æºä»£ç ä¸­æ²¡æœ‰0x7eå¯¹åº”çš„è§£é‡Šï¼Œæ­£å¦‚ä¸Šå›¾ä¸­æ‰€ç¤ºã€‚diag å‘½ä»¤æ˜¯åµŒå¥—çš„ï¼Œå¤–å±‚ç”±0x7eåå…­è¿›åˆ¶çš„åŒ…è£…å™¨ç»„æˆï¼Œç„¶åæ˜¯ä¸»å‘½ä»¤ï¼Œç„¶åæ˜¯ä¸€äº›å¯å˜é•¿åº¦æ•°æ®ï¼Œå¯ä»¥åŒ…å«æ›´å¤šå­å‘½ä»¤ï¼Œè¿™æ•´ä¸ªå‘½ä»¤æ˜¯ä½¿ç”¨ crc éªŒè¯çš„ï¼Œå¹¶ä¸”ä¸€äº›å­—èŠ‚è¢«ä¸“é—¨è½¬ä¹‰ï¼Œä½ å¯ä»¥åœ¨ä»£ç ç‰‡æ®µä¸­çœ‹åˆ°

- ![](pic/2024-01-21-14-27-13.png)
- åŸºå¸¦å­ç³»ç»Ÿçš„è¯Šæ–­ç³»ç»Ÿæ‰©å±• 
  - â—‹ ~100 ä¸ªå­ç³»ç»Ÿ + OEM ä¿ç•™ 
  - â—‹ å­ç³»ç»Ÿå¯ä»¥ä½¿ç”¨ DIAG ä»»åŠ¡æ³¨å†Œå…¶è‡ªå®šä¹‰å¤„ç†ç¨‹åº 
  - â—‹ æ•°æ®åŒ…ä¸é€æ˜ 
  - â— DIAG_CMD_SUBSYS = 75 
  - â— struct { â—‹ u8 subsys_id; â—‹ u16 å­ç³»ç»Ÿå‘½ä»¤ï¼› â—‹ æœ‰æ•ˆè´Ÿè½½ï¼ˆå¯å˜é•¿åº¦ï¼‰}
- diagåè®®æ”¯æŒå­ç³»ç»Ÿæ‰©å±•ï¼ŒåŸºæœ¬ä¸ŠåŸºå¸¦ä¸­ä¸åŒçš„å­ç³»ç»Ÿéƒ½å¯ä»¥æ³¨å†Œå®ƒä»¬è‡ªå·±çš„diagå¤„ç†å‡½æ•°ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªç‰¹æ®Šçš„diagå‘½ä»¤75ï¼Œå®ƒç®€å•åœ°è½¬å‘æŒ‡ä»¤ï¼Œå³diagç³»ç»Ÿå°†æ­¤å‘½ä»¤è½¬å‘åˆ°ç›¸åº”çš„å­ç³»ç»Ÿï¼Œç„¶åå®ƒå°†åœ¨é‚£é‡Œè¿›è¡Œè§£æã€‚

![](pic/2024-01-21-14-50-43.png)
- å­˜åœ¨ç›¸å½“å¤šçš„å­ç³»ç»Ÿï¼Œä½†æœ‰äº›æœªè¢«æ–‡æ¡£å…¬å¼€ï¼Œé€šè¿‡è°ƒæŸ¥å‘ç°å­˜åœ¨DIAG subsystem subsystemï¼ˆ18ï¼‰ä»¥åŠDEBUGï¼ˆ37ï¼‰å­ç³»ç»Ÿï¼Œå¯¹åè€…å¾ˆå¥½å¥‡ï¼Œå°è¯•é€šè¿‡è¯¥ç³»ç»Ÿå¼€å¯ä¸€äº›é«˜çº§è°ƒè¯•åŠŸèƒ½


- ![](pic/2024-01-21-14-54-53.png)
- ![](pic/2024-01-21-14-56-04.png)
- ä½†äº‹å®è¯æ˜è°ƒè¯•å­ç³»ç»Ÿéå¸¸ç®€å•ï¼Œå®ƒåªæ”¯æŒä¸€ä¸ªå‘½ä»¤ æ³¨å…¥å´©æºƒï¼Œæ‰€ä»¥ä½ å¯ä»¥å‘é€ä¸€ä¸ªç‰¹æ®Šçš„ç›´æ¥å‘½ä»¤ï¼Œè¿™ä¼šå°†å´©æºƒæ³¨å…¥åŸºå¸¦


- ![](pic/2024-01-21-14-56-48.png)
- æŸ¥çœ‹ä¸€ä¸ªdiagåè®®ä¾‹å­
- è¿™æ˜¯æ¥è‡ª snoop snitch çš„æ³¨é‡Šç‰‡æ®µ
- è¿™ä¸ªblobå®é™…ä¸Šç”±ä¸‰ä¸ªé€»è¾‘éƒ¨åˆ†ç»„æˆ 
  - ç¬¬ä¸€éƒ¨åˆ†æ— å…³ç´§è¦ï¼Œå®ƒæ˜¯å‘½ä»¤ç”¨äºè¯·æ±‚æ¥è‡ªåŸºå¸¦çš„å„ç§ä¿¡æ¯ï¼Œä¾‹å¦‚æ—¶é—´æˆ³ç‰ˆæœ¬å’Œversionã€buildidç­‰
  - ç¬¬äºŒç»„æ³¨é‡Šä»¥å‘½ä»¤å· 0x73 å¼€å¤´ï¼Œè¿™æ˜¯diagçš„æ—¥å¿—é…ç½®å‘½ä»¤ï¼Œè¯¥å¯ç”¨åè®®è½¬å‚¨å¹¶é…ç½®å®ƒä»¬ï¼Œ
  - è¯¥ blob çš„ç¬¬ä¸‰éƒ¨åˆ†ä»¥å‘½ä»¤å· 0x7d å¼€å¤´ï¼Œè¿™æ˜¯æ¶ˆæ¯é…ç½®çš„diagå‘½ä»¤ï¼Œè¿™å®é™…ä¸Šæ˜¯åº”è¯¥å¯ç”¨æ–‡æœ¬æ¶ˆæ¯ç™»å½•çš„å‘½ä»¤ï¼Œé™¤äº†åœ¨ç›‘å¬å‘Šå¯†çš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šç¦ç”¨ æ‰€æœ‰æ—¥å¿—è®°å½•éƒ½åœ¨ä¸€èµ·
- è¿™éƒ¨åˆ†æ²¡æœ‰å¬å¤ªæ‡‚

- ![](pic/2024-01-21-15-05-34.png)
- â— å¯ç”¨èœ‚çªåè®®è½¬å‚¨ â— å‘½ä»¤æ ¼å¼éƒ¨åˆ†è®°å½•åœ¨ libqcdm ğŸ‘‡ğŸ» ä¸­ â— Op = å­å‘½ä»¤ â— è®¾å¤‡ ID â—‹ GSM (5)ã€UMTS (7)ã€TDSCDMA (13)
- é‚£ä¹ˆï¼Œèœ‚çªåè®®è½¬å‚¨å®é™…ä¸Šæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸ºäº†å¯ç”¨èœ‚çªåè®®è½¬å‚¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªdiagå‘½ä»¤logé…ç½®å· 0x73 å®ƒéƒ¨åˆ†è®°å½•åœ¨ lipqcdm ä¸­,æ•°æ®åŒ…çš„ç»“æ„å°†åŒ…å«ä»£ç ã€å­å‘½ä»¤ï¼ˆå°†è®¾ç½®æ©ç ï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒè¿˜éœ€è¦ä¸€ä¸ªè®¾å¤‡ IDï¼Œè¯¥idå€¼ä¸è¦è½¬å‚¨çš„ç‰¹å®šåè®®ç›¸å¯¹åº”çš„ï¼Œæœ€åæ˜¯ç”¨äºè¿‡æ»¤è½¬å‚¨æŸäº›éƒ¨åˆ†çš„æ©ç ï¼Œè¿™éƒ¨åˆ†ç›¸å¯¹ç®€å•

- ![](pic/2024-01-21-15-19-57.png)
- DIAG_CMD_EXT_MESSAGE_CONFIG (0x7D)
  - å¯ç”¨/ç¦ç”¨å’Œé…ç½®æ–‡æœ¬æ¶ˆæ¯æ—¥å¿—è®°å½• 
  - â— å‘½ä»¤æ ¼å¼æœªè®°å½• 
  - â— å¯¹å­å‘½ä»¤è¿›è¡Œæ“ä½œ 
    - â—‹ è®¾ç½®æ—¥å¿—è®°å½•æ©ç  
  - â— æ—¥å¿—æ©ç  
    - â—‹ æ ¹æ®æŠ¥å‘Šçš„æ¶ˆæ¯æ—¥å¿—çº§åˆ«æŒ‰ä½åº”ç”¨  
    - â—‹ æ©ç  0x0 ç¦ç”¨æ‰€æœ‰æ—¥å¿—è®°å½•ï¼Œ0xFFFFFFFF å¯ç”¨æ‰€æœ‰æ—¥å¿—è®°å½•
  - â— SSID
    - â—‹ æŒ‰å­ç³»ç»Ÿ ID è¿‡æ»¤ 
    - â—‹ä¸ DIAG å­ç³»ç»Ÿä¸åŒ
- ç¬¬äºŒä¸ªå‘½ä»¤æ˜¯diagæ–‡æœ¬æ¶ˆæ¯é…ç½®å‘½ä»¤ï¼ˆå¯¹åº”0x7D å³DIAG_CMD_EXT_MESSAGE_CONFIGï¼‰ï¼Œè¯¥å‘½ä»¤å¼€å¯æ–‡æœ¬æ¶ˆæ¯logè¾“å‡ºï¼Œè¯¥æ¶ˆæ¯æ ¼å¼æœªå…¬å¼€
- æ­¤å¤„å­˜åœ¨ä¸€ä¸ªå­å‘½ä»¤ 0x4ï¼Œç”¨äºè®¾ç½®æ©ç ï¼Œä¹‹åæ˜¯ä¸¤ä¸ª16ä½æ•´æ•°ï¼Œè¡¨ç¤ºssid start å’Œ ssid endï¼ˆssidæ˜¯å­ç³»ç»Ÿidï¼Œä¸diagå­ç³»ç»Ÿä¸åŒï¼‰ï¼Œæœ€åä¸€ä¸ªæ˜¯æ©ç ï¼Œ
- å› æ­¤å­ç³»ç»Ÿ id ç”¨äºæ ¹æ®ç‰¹å®šå­ç³»ç»Ÿè¿‡æ»¤æ¶ˆæ¯ï¼Œå› ä¸ºåŸºå¸¦æœ‰å¤§é‡çš„å­ç³»ç»Ÿï¼Œå¦‚æœæ‰€æœ‰å­ç³»ç»Ÿéƒ½å¼€å§‹è®°å½•ï¼Œè¿™å°†æ˜¯å¤§é‡çš„æ•°æ®
- æ­¤å¤„pythonä»£ç ç”¨äºå¼€å¯æ‰€æœ‰å­ç³»ç»Ÿçš„æ¶ˆæ¯æ—¥å¿—ï¼Œä¼šäº§ç”Ÿå¾ˆå¤šæ—¥å¿—æ¶ˆæ¯

- ![](pic/2024-01-21-15-34-04.png)
- ç°åœ¨ï¼Œä¸ºäº†è§£æä¼ å…¥çš„æ—¥å¿—æ¶ˆæ¯ï¼Œæœ‰ä¸¤ç§ç±»å‹diagä»¤ç‰Œä¸­ï¼Œå®ƒä»¬éƒ½æ²¡æœ‰è®°å½•ï¼Œ
- ç¬¬ä¸€ç§ DIAG_CMD_LOG_MESSAGE (0x79/121)
  - ç®€å•çš„åŸºäºascçš„æ¶ˆæ¯ï¼Œé€šè¿‡diagæ¥å£åˆ°è¾¾ï¼Œæ•…å¯ä»¥ç›´æ¥è§£æ
- ç¬¬äºŒç§ DIAG_CMD_LOG_HASH (0x92/146)
  - è¿™æ˜¯å¯¹æ—¥å¿—æ¶ˆæ¯è¿›è¡Œç¼–ç çš„ä»¤ç‰Œï¼Œè¯¥ä»¤ç‰Œä»…åŒ…å«å“ˆå¸Œå€¼ï¼Œå¯ä»¥é€šè¿‡msg_hash.txtæ–‡ä»¶è§£æ
- ä¸¤è€…ç»“æ„ç±»ä¼¼
  - ç¬¬ä¸€å­—èŠ‚cmdå­—æ®µ
  - ç¬¬ä¸‰å­—èŠ‚å‚æ•°æ•°é‡
  - 64bitçš„æ—¶é—´æˆ³
  - 16bitçš„ssid
  - æœ€åæ˜¯asciiå­—ç¬¦ä¸²æˆ–logå­—ç¬¦ä¸²hash
  - å¯ä»¥åŒ…å«ä¸€äº›å‚æ•°ï¼Œä½äºä¸¤ç§æ¶ˆæ¯çš„ä¸åŒä½ç½®

- ![](pic/2024-01-21-16-11-16.png)
- è¿™æ˜¯ä¸€ä¸ªdiagæ•°æ®åŒ…ï¼Œè‡³å°‘åœ¨ç†è®ºä¸Šä½¿æ‚¨èƒ½å¤Ÿå°†å´©æºƒæ³¨å…¥åŸºå¸¦ï¼Œå› ä¸ºåœ¨æˆ‘çš„æƒ…å†µä¸‹å®ƒä¸èµ·ä½œç”¨
- æˆ‘æ‰€è¯´çš„ä¸å·¥ä½œæ˜¯æŒ‡å®ƒå¯¹åŸºå¸¦æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œé€šå¸¸æ˜¯æœŸæœ›è¯¥æ¶ˆæ¯èƒ½åœ¨ç”Ÿäº§è®¾å¤‡ä¸­è§¦å‘å¹¶è·å¾—crashdump
- å®ƒåº”è¯¥èƒ½åœ¨å…¶ä»–ä¸€äº›è®¾å¤‡ä¸Šè§¦å‘crashï¼Œæ‰€ä»¥å€¼å¾—æ£€æŸ¥ä¸€ä¸‹ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è¯·æ±‚å‡ ç§ç±»å‹çš„å´©æºƒ

- ![](pic/2024-01-21-16-17-35.png)
- ![](pic/2024-01-21-16-17-47.png)
- 
ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘éœ€è¦ä¸€ä¸ªéå¸¸ç®€å•çš„å·¥å…·ï¼ŒåŸºæœ¬ä¸Šæœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆæ˜¯ç›´æ¥è½»æ¾è®¿é—® diag æ¥å£ï¼Œç†æƒ³åœ°é€šè¿‡æŸç§ pythonshellï¼Œå…¶æ¬¡æ˜¯èƒ½å¤Ÿä½¿ç”¨é«˜çº§æ—¥å¿—å­—ç¬¦ä¸²è¯»å–å’Œè§£ææ•°æ®ï¼Œä¸ºæ­¤æˆ‘ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œæˆ‘å°†å…¶å‘½åä¸º diag talkï¼Œå®ƒç›´æ¥åŸºäºandroid å†…æ ¸ä¸­çš„ dev diag æ¥å£
- å› æ­¤å·¦ä¾§æ˜¯ä¸€äº›å¸¦æœ‰é“¾æ¥å€¼çš„é«˜çº§è§£æçš„ç¤ºä¾‹ï¼Œå³ä¾§æ˜¯é«˜çº§æ¶ˆæ¯æ—¥å¿—çš„ç¤ºä¾‹ï¼Œå…¶ä¸­åŒ…æ‹¬ä»ä¸­æå–çš„æ—¥å¿—å­—ç¬¦ï¼Œæ­£å¦‚æˆ‘æ‰€æœŸæœ›çš„é‚£æ ·ï¼Œå®ƒæœ‰å¾ˆå¤šè¯¦ç»†çš„æ•°æ®ï¼Œä¾‹å¦‚ GPSåæ ‡å’ŒåŸºå¸¦è¿æ¥åˆ°ä¸åŒé€šé“çš„å„ç§å°è¯•ï¼Œæˆ‘è®¤ä¸ºå®ƒå¯¹äºè¿›æ”»æ€§ç ”ç©¶ç›®çš„éå¸¸æœ‰ç”¨ï¼Œæœ‰æ—¶å®ƒç”šè‡³åŒ…å«æ­£å¦‚æ‚¨åœ¨å±å¹•æˆªå›¾ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼ŒåŸå§‹æŒ‡é’ˆ

- ![](pic/2024-01-21-16-26-51.png)
- ç»“è®º éœ€è¦å®ç°åŸºäºè½¯ä»¶çš„è°ƒè¯•å™¨
- Qualcomm Hexagon 
  - â— å…¶ä»– Qualcomm ä¸“æœ‰è¯Šæ–­åè®®  ï¼ˆä¾‹å¦‚QMIï¼‰
  - â— QEMU Hexagonï¼ˆç°ä»£ï¼ï¼‰å…¨ç³»ç»Ÿä»¿çœŸ 
  - â— ç”¨äºäº§å“ç†”æ–­è®¾å¤‡çš„åŸºäºè½¯ä»¶çš„è°ƒè¯•å™¨ 
  - â— JTAG ç†”æ–­æ—è·¯ 
  - â— OTA çŸ¢é‡ 
  - â— MP -> AP å‡çº§ 
  - â— åç¼–è¯‘å™¨ 
  - â— äºŒè¿›åˆ¶è¡¥ä¸æ¯”è¾ƒ
- åŸºå¸¦ï¼šç¤¾åŒºç ”ç©¶ 
  - â— CDMA BTS è½¯ä»¶å®æ–½ 
  - â— ç¨å¾®æ›´æ–° osmocommBB 
  - â— å¼€æ”¾é¢‘è°±çš„å¼€æºèœ‚çªç”Ÿæ€ç³»ç»Ÿ 
    - â—‹ ä»æŠ€æœ¯ä¸Šè®²ï¼Œæ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢èœ‚çªåè®®åœ¨æœªç»è®¸å¯çš„æ— çº¿ç”µé¢‘æ®µä¸Šè¿è¡Œ 
    - â—‹ ä½†åŸºå¸¦é€šè¿‡ç¡¬ä»¶åŠŸèƒ½é”å®šåˆ°æ— çº¿ç”µé¢‘æ®µ +å›ºä»¶ç¼–ç¨‹ 
    - â—‹ æœ‰äº›æ‰‹æœºè¡¨é¢ä¸Šä¼¼ä¹æ”¯æŒ 2.4Ghz/5Ghz (bb) 
    - â—‹ æ‰€ä»¥åº”è¯¥å¯ä»¥é‡æ–°é…ç½®åŸºå¸¦æ— çº¿ç”µå±‚ 
    - â—‹ SDR ä¸Šçš„ BTS æ²¡æœ‰åšä»»ä½•å‡è®¾


- å‚è€ƒ
- References
[CCC2011] Reverse engineering a Qulacomm baseband 
https://fahrplan.events.ccc.de/congress/2011/Fahrplan/attachments/2022_11-ccc-qcombbdbg.pdf
[HEXAGONDSP] Qualcomm Hexagon DSP: An architecture optimized for mobile multimedia and communications 
https://developer.qualcomm.com/download/hexagon/hexagon-dsp-architecture.pdf
[HEXAGONISA] Hexagon V62 Programmer's Reference Manual 
https://developer.qualcomm.com/download/hexagon/hexagon-v62-programmers-reference-manual.pdf
[MODKIT] Exploring Qualcomm Baseband via ModKit (2018) 
https://cansecwest.com/slides/2018/Exploring%20Qualcomm%20Baseband%20via%20ModKit%20-%20Peter%20Pi,%20XiLing
%20Gong,%20and%20Gmxp,%20Tencent%20Security%20Platform%20Department.pdf
[HYPERVISORS] Hypervisor vulnerability research: state of the art 
https://alisa.sh/slides/HypervisorVulnerabilityResearch2020.pdf
[PRODFUSING] Leaked Qualcomm memo on production fusing https://pastebin.com/DUEbnuTf
[SNAPDRAGON] QualcommÂ® Snapdragonâ„¢ 820E Processor (APQ8096SGE) 
https://developer.qualcomm.com/download/sd820e/qualcomm-snapdragon-820e-processor-apq8096sge-device-specification.pdf


![](pic/2024-01-21-16-32-27.png)


å…³äºé«˜é€šwifièŠ¯ç‰‡ æœªæ¥å¾—åŠçœ‹

- é»˜è®¤æƒ…å†µä¸‹ï¼Œdiagç”Ÿæ€ä¸å…è®¸ä½ å‘é€ä»»æ„diagå‘½ä»¤ï¼Œä¸ºäº†å®ç°å‘é€ä»»æ„diagå‘½ä»¤ï¼Œæœ‰ä¸¤ç§æ€è·¯
  - é‡å»ºdiagé©±åŠ¨ç¨‹åºï¼Œä»è€Œå…è®¸ä»»æ„diagå‘½ä»¤å‘é€
  - å¦ä¸€ç§æ–¹æ³•æ˜¯ç›´æ¥è®¿é—®å…±äº«å†…å­˜ï¼Œå› ä¸ºé«˜é€šå…±äº«å†…å­˜æœºåˆ¶ä¼šæ›´åŠ å¤æ‚ï¼Œæ‰€ä»¥è¿™æ›´éš¾
  - hack diagé©±åŠ¨ç¨‹åºï¼Œä½¿ç”¨diagç•Œé¢è¿›è¡Œå¼€å‘
